# Postman Testing Guide - Wallet Topup Flow

H∆∞·ªõng d·∫´n test lu·ªìng n·∫°p ti·ªÅn v√≠ qua Postman v·ªõi ƒë·∫ßy ƒë·ªß c√°c b∆∞·ªõc t·ª´ t·∫°o intent ƒë·∫øn ho√†n t·∫•t giao d·ªãch.

## Chu·∫©n b·ªã

### 1. Environment Variables
T·∫°o Environment trong Postman v·ªõi c√°c bi·∫øn sau:

```json
{
  "base_url": "http://localhost:8000",
  "access_token": "",
  "refresh_token": "",
  "user_id": "",
  "intent_id": "",
  "order_code": "",
  "sepay_tx_id": ""
}
```

### 2. Authentication Headers
T·∫•t c·∫£ c√°c request c·∫ßn header:
```
Authorization: Bearer {{access_token}}
Content-Type: application/json
```

## B∆∞·ªõc 1: ƒêƒÉng nh·∫≠p (Authentication)

### Request: Login
```http
POST {{base_url}}/api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "your_password"
}
```

### Response Success:
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "username": "testuser",
    "first_name": "Test",
    "last_name": "User"
  }
}
```

### Postman Test Script:
```javascript
if (pm.response.code === 200) {
    const response = pm.response.json();
    pm.environment.set("access_token", response.access_token);
    pm.environment.set("refresh_token", response.refresh_token);
    pm.environment.set("user_id", response.user.id);
    console.log("Authentication successful");
}
```

## B∆∞·ªõc 2: Ki·ªÉm tra Wallet hi·ªán t·∫°i

### Request: Get Current Wallet
```http
GET {{base_url}}/api/seapay/wallet
Authorization: Bearer {{access_token}}
```

### Response Success:
```json
{
  "wallet_id": "123e4567-e89b-12d3-a456-426614174000",
  "balance": 0.00,
  "currency": "VND",
  "status": "active",
  "created_at": "2025-09-22T10:00:00Z",
  "updated_at": "2025-09-22T10:00:00Z"
}
```

## B∆∞·ªõc 3: T·∫°o Wallet Topup Intent

### Request: Create Topup Intent
```http
POST {{base_url}}/api/seapay/wallet/topup/create
Authorization: Bearer {{access_token}}
Content-Type: application/json

{
  "amount": 100000,
  "currency": "VND",
  "bank_code": "BIDV",
  "expires_in_minutes": 60
}
```

### Response Success:
```json
{
  "intent_id": "123e4567-e89b-12d3-a456-426614174001",
  "order_code": "TOPUP_1695369600_A1B2C3D4",
  "amount": 100000,
  "currency": "VND",
  "status": "processing",
  "qr_image_url": "https://api.vietqr.io/image/VCB-1234567890-vietqr.jpg?amount=100000&addInfo=TOPUP_1695369600_A1B2C3D4",
  "account_number": "1234567890",
  "account_name": "CONG TY ABC",
  "transfer_content": "TOPUP_1695369600_A1B2C3D4",
  "bank_code": "VCB",
  "expires_at": "2025-09-22T11:00:00Z",
  "message": "Topup request created successfully. Please scan QR code to complete payment."
}
```

### Postman Test Script:
```javascript
if (pm.response.code === 200) {
    const response = pm.response.json();
    pm.environment.set("intent_id", response.intent_id);
    pm.environment.set("order_code", response.order_code);
    console.log("Topup intent created:", response.intent_id);
    console.log("Order code:", response.order_code);
    console.log("QR URL:", response.qr_image_url);
}
```

## B∆∞·ªõc 4: Ki·ªÉm tra tr·∫°ng th√°i Topup

### Request: Get Topup Status
```http
GET {{base_url}}/api/seapay/wallet/topup/{{intent_id}}/status
Authorization: Bearer {{access_token}}
```

### Response Success (Pending):
```json
{
  "intent_id": "123e4567-e89b-12d3-a456-426614174001",
  "order_code": "TOPUP_1695369600_A1B2C3D4",
  "amount": 100000,
  "status": "processing",
  "is_expired": false,
  "qr_image_url": "https://api.vietqr.io/image/VCB-1234567890-vietqr.jpg?amount=100000&addInfo=TOPUP_1695369600_A1B2C3D4",
  "account_number": "1234567890",
  "account_name": "CONG TY ABC",
  "transfer_content": "TOPUP_1695369600_A1B2C3D4",
  "bank_code": "VCB",
  "expires_at": "2025-09-22T11:00:00Z",
  "payment_id": null,
  "provider_payment_id": null,
  "balance_before": null,
  "balance_after": null,
  "completed_at": null,
  "message": "Topup status: processing"
}
```

## B∆∞·ªõc 5: M√¥ ph·ªèng SePay Webhook (Test)

### Request: SePay Webhook Simulation
```http
POST {{base_url}}/api/seapay/webhook/sepay
Content-Type: application/json

{
  "id": 987654321,
  "gateway": "VCB",
  "transactionDate": "2025-09-22T10:30:00Z",
  "accountNumber": "1234567890",
  "subAccount": "",
  "code": "VCB",
  "content": "{{order_code}}",
  "transferType": "in",
  "description": "Nap tien vi",
  "transferAmount": 100000,
  "referenceCode": "REF123456789"
}
```

### Response Success:
```json
{
  "status": "success",
  "message": "Topup completed successfully",
  "payment_id": "123e4567-e89b-12d3-a456-426614174002",
  "processed_at": "2025-09-22T10:30:05Z"
}
```

### Postman Test Script:
```javascript
if (pm.response.code === 200) {
    const response = pm.response.json();
    pm.environment.set("sepay_tx_id", "987654321");
    console.log("Webhook processed:", response.status);
    console.log("Payment ID:", response.payment_id);
}
```

## B∆∞·ªõc 6: Ki·ªÉm tra tr·∫°ng th√°i sau khi thanh to√°n

### Request: Get Topup Status After Payment
```http
GET {{base_url}}/api/seapay/wallet/topup/{{intent_id}}/status
Authorization: Bearer {{access_token}}
```

### Response Success (Completed):
```json
{
  "intent_id": "123e4567-e89b-12d3-a456-426614174001",
  "order_code": "TOPUP_1695369600_A1B2C3D4",
  "amount": 100000,
  "status": "succeeded",
  "is_expired": false,
  "qr_image_url": "https://api.vietqr.io/image/VCB-1234567890-vietqr.jpg?amount=100000&addInfo=TOPUP_1695369600_A1B2C3D4",
  "account_number": "1234567890",
  "account_name": "CONG TY ABC",
  "transfer_content": "TOPUP_1695369600_A1B2C3D4",
  "bank_code": "VCB",
  "expires_at": "2025-09-22T11:00:00Z",
  "payment_id": "123e4567-e89b-12d3-a456-426614174002",
  "provider_payment_id": "987654321",
  "balance_before": 0.00,
  "balance_after": 100000.00,
  "completed_at": "2025-09-22T10:30:00Z",
  "message": "Topup status: succeeded"
}
```

## B∆∞·ªõc 7: Ki·ªÉm tra Wallet sau khi n·∫°p ti·ªÅn

### Request: Get Updated Wallet Balance
```http
GET {{base_url}}/api/seapay/wallet
Authorization: Bearer {{access_token}}
```

### Response Success:
```json
{
  "wallet_id": "123e4567-e89b-12d3-a456-426614174000",
  "balance": 100000.00,
  "currency": "VND",
  "status": "active",
  "created_at": "2025-09-22T10:00:00Z",
  "updated_at": "2025-09-22T10:30:05Z"
}
```

## B∆∞·ªõc 8: Xem l·ªãch s·ª≠ n·∫°p ti·ªÅn

### Request: Get Topup History
```http
GET {{base_url}}/api/seapay/wallet/topup/history?page=1&limit=10
Authorization: Bearer {{access_token}}
```

### Response Success:
```json
{
  "results": [
    {
      "intent_id": "123e4567-e89b-12d3-a456-426614174001",
      "order_code": "TOPUP_1695369600_A1B2C3D4",
      "amount": 100000,
      "status": "succeeded",
      "expires_at": "2025-09-22T11:00:00Z",
      "is_expired": false,
      "created_at": "2025-09-22T10:00:00Z",
      "qr_image_url": "https://api.vietqr.io/image/VCB-1234567890-vietqr.jpg?amount=100000&addInfo=TOPUP_1695369600_A1B2C3D4",
      "payment_id": "123e4567-e89b-12d3-a456-426614174002",
      "completed_at": "2025-09-22T10:30:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 1,
    "pages": 1,
    "has_next": false,
    "has_previous": false
  }
}
```

## Test Cases n√¢ng cao

### Test Case 1: H·ªßy topup
```http
POST {{base_url}}/api/seapay/wallet/topup/{{intent_id}}/cancel
Authorization: Bearer {{access_token}}
```

### Test Case 2: Topup v·ªõi s·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá
```http
POST {{base_url}}/api/seapay/wallet/topup/create
Authorization: Bearer {{access_token}}
Content-Type: application/json

{
  "amount": -1000,
  "currency": "VND",
  "bank_code": "VCB"
}
```

### Test Case 3: Webhook v·ªõi content kh√¥ng kh·ªõp
```http
POST {{base_url}}/api/seapay/webhook/sepay
Content-Type: application/json

{
  "id": 987654322,
  "content": "INVALID_ORDER_CODE",
  "transferAmount": 100000,
  "transferType": "in"
}
```

## Postman Collection Structure

```
üìÅ Wallet Topup Flow
‚îú‚îÄ‚îÄ üìÅ 01. Authentication
‚îÇ   ‚îú‚îÄ‚îÄ Login
‚îÇ   ‚îî‚îÄ‚îÄ Refresh Token
‚îú‚îÄ‚îÄ üìÅ 02. Wallet Management
‚îÇ   ‚îú‚îÄ‚îÄ Get Current Wallet
‚îÇ   ‚îî‚îÄ‚îÄ Get Wallet History
‚îú‚îÄ‚îÄ üìÅ 03. Topup Flow
‚îÇ   ‚îú‚îÄ‚îÄ Create Topup Intent
‚îÇ   ‚îú‚îÄ‚îÄ Get Topup Status
‚îÇ   ‚îú‚îÄ‚îÄ Cancel Topup
‚îÇ   ‚îî‚îÄ‚îÄ Get Topup History
‚îú‚îÄ‚îÄ üìÅ 04. Webhook Simulation
‚îÇ   ‚îú‚îÄ‚îÄ SePay Webhook Success
‚îÇ   ‚îú‚îÄ‚îÄ SePay Webhook Invalid Content
‚îÇ   ‚îî‚îÄ‚îÄ SePay Webhook Invalid Amount
‚îî‚îÄ‚îÄ üìÅ 05. Error Cases
    ‚îú‚îÄ‚îÄ Unauthorized Request
    ‚îú‚îÄ‚îÄ Invalid Amount
    ‚îú‚îÄ‚îÄ Expired Intent
    ‚îî‚îÄ‚îÄ Suspended Wallet
```

## Automated Testing Script

### Pre-request Script (Collection Level):
```javascript
// Set current timestamp
pm.globals.set("timestamp", new Date().toISOString());

// Log request info
console.log("Making request to:", pm.request.url.toString());
```

### Test Script (Collection Level):
```javascript
// Log response
console.log("Response status:", pm.response.code);
console.log("Response time:", pm.response.responseTime + "ms");

// Common assertions
pm.test("Response time is less than 2000ms", function () {
    pm.expect(pm.response.responseTime).to.be.below(2000);
});

pm.test("Content-Type is application/json", function () {
    pm.expect(pm.response.headers.get("Content-Type")).to.include("application/json");
});
```

## Monitoring v√† Debugging

### Environment Variables cho Debug:
```json
{
  "debug_mode": true,
  "log_level": "verbose",
  "timeout": 30000
}
```

### Error Response Examples:

**400 Bad Request:**
```json
{
  "error": "Amount must be greater than 0",
  "detail": "Invalid amount provided"
}
```

**401 Unauthorized:**
```json
{
  "error": "Authentication credentials were not provided"
}
```

**404 Not Found:**
```json
{
  "error": "Topup intent not found"
}
```

**500 Internal Server Error:**
```json
{
  "error": "Failed to create topup request: Database connection error"
}
```

## Checklist Validation

### ‚úÖ Tr∆∞·ªõc khi test:
- [ ] Server Django ƒëang ch·∫°y
- [ ] Database ƒë√£ migrate
- [ ] User ƒë√£ ƒë∆∞·ª£c t·∫°o v√† c√≥ th·ªÉ login
- [ ] Environment variables ƒë√£ ƒë∆∞·ª£c set

### ‚úÖ Trong qu√° tr√¨nh test:
- [ ] Access token h·ª£p l·ªá
- [ ] Response status codes ƒë√∫ng
- [ ] Response data structure ƒë√∫ng
- [ ] Environment variables ƒë∆∞·ª£c update

### ‚úÖ Sau khi test:
- [ ] Wallet balance ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng
- [ ] Database records ƒë∆∞·ª£c t·∫°o
- [ ] Logs kh√¥ng c√≥ errors
- [ ] All test assertions pass