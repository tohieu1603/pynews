# üéØ H·ªá th·ªëng Mua Quy·ªÅn Truy c·∫≠p Symbol - API Documentation & Testing Guide

H·ªá th·ªëng cho ph√©p user mua quy·ªÅn truy c·∫≠p c√°c m√£ ch·ª©ng kho√°n (symbol) v·ªõi 2 ph∆∞∆°ng th·ª©c thanh to√°n: **Wallet** (v√≠ n·ªôi b·ªô) ho·∫∑c **SePay Transfer** (chuy·ªÉn kho·∫£n ng√¢n h√†ng).

## üîí Validation & Security

### Ki·ªÉm tra s·ªë d∆∞ v√≠
- **Wallet Payment**: H·ªá th·ªëng ki·ªÉm tra s·ªë d∆∞ v√≠ TR∆Ø·ªöC khi t·∫°o ƒë∆°n h√†ng
- N·∫øu s·ªë d∆∞ < t·ªïng ƒë∆°n h√†ng ‚Üí **B√°o l·ªói ngay l·∫≠p t·ª©c** 
- **SePay Payment**: Kh√¥ng ki·ªÉm tra s·ªë d∆∞, t·∫°o ƒë∆°n h√†ng v√† ch·ªù thanh to√°n

**V√≠ d·ª• validation:**
```
User c√≥ v√≠: 10,000 VND
Mua symbol gi√°: 100,000 VND
‚Üí K·∫øt qu·∫£: "Insufficient wallet balance. Required: 100000 VND, Available: 10000.00 VND"
```

## üìã T·ªïng quan lu·ªìng

```mermaid
graph TD
    A[User ch·ªçn symbol] --> B[T·∫°o ƒë∆°n h√†ng]
    B --> C{Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n}
    
    C -->|Wallet| D[Ki·ªÉm tra s·ªë d∆∞ v√≠]
    D --> E[Tr·ª´ ti·ªÅn t·ª´ v√≠]
    E --> F[Ghi s·ªï c√°i ledger]
    F --> G[C·∫•p license symbol]
    
    C -->|SePay| H[T·∫°o Payment Intent]
    H --> I[Sinh QR code]
    I --> J[User qu√©t m√£ thanh to√°n]
    J --> K[SePay webhook callback]
    K --> G
    
    G --> L[Ho√†n t·∫•t - User c√≥ th·ªÉ truy c·∫≠p signal symbol]
```

## üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

### Database Tables

#### 1. `pay_symbol_orders` - ƒê∆°n h√†ng
```sql
- order_id (UUID, PK)
- user_id (BIGINT) ‚Üí users.id  
- total_amount (DECIMAL)
- status: pending_payment | paid | failed | cancelled | refunded
- payment_method: wallet | sepay_transfer
- description (TEXT)
- payment_intent_id (UUID) ‚Üí pay_payment_intents.intent_id
- created_at, updated_at
```

#### 2. `pay_symbol_order_items` - Chi ti·∫øt s·∫£n ph·∫©m
```sql
- order_item_id (UUID, PK)
- order_id (UUID) ‚Üí pay_symbol_orders.order_id
- symbol_id (BIGINT) ‚Üí symbol.id (Symbol ƒë∆∞·ª£c mua quy·ªÅn truy c·∫≠p)
- price (DECIMAL) 
- license_days (INT) - NULL = tr·ªçn ƒë·ªùi
- metadata (JSON)
```

#### 3. `pay_user_symbol_licenses` - Quy·ªÅn s·ª≠ d·ª•ng symbol
```sql
- license_id (UUID, PK)
- user_id (BIGINT) ‚Üí users.id
- symbol_id (BIGINT) ‚Üí symbol.id
- order_id (UUID) ‚Üí pay_symbol_orders.order_id
- status: active | expired | suspended | revoked
- start_at (TIMESTAMP)
- end_at (TIMESTAMP) - NULL = tr·ªçn ƒë·ªùi
- created_at
```

#### 4. `pay_wallet_ledger` - S·ªï c√°i v√≠ (Updated)
```sql
- ledger_id (UUID, PK)
- wallet_id (UUID) ‚Üí pay_wallets.wallet_id
- tx_type: deposit | purchase | refund | withdrawal | transfer_in | transfer_out
- amount (DECIMAL)
- is_credit (BOOLEAN) - true: c·ªông ti·ªÅn, false: tr·ª´ ti·ªÅn
- balance_before, balance_after (DECIMAL)
- order_id (UUID) ‚Üí pay_symbol_orders.order_id [M·ªöI]
- payment_id (UUID) ‚Üí pay_payments.payment_id
- note (TEXT) [M·ªöI]
- metadata (JSON)
- created_at
```

## üîÑ Chi ti·∫øt lu·ªìng ho·∫°t ƒë·ªông

### B∆∞·ªõc 1: T·∫°o ƒë∆°n h√†ng

**API:** `POST /api/seapay/symbol/order/create`

```json
{
  "items": [
    {
      "symbol_id": 123,          // ID c·ªßa symbol (m√£ ch·ª©ng kho√°n)
      "price": 500000,           // Gi√° b√°n (VND)
      "license_days": 30,        // Th·ªùi h·∫°n s·ª≠ d·ª•ng (null = tr·ªçn ƒë·ªùi)
      "metadata": {
        "version": "v2.0",
        "features": ["signal", "backtest"]
      }
    }
  ],
  "payment_method": "wallet",    // "wallet" ho·∫∑c "sepay_transfer"
  "description": "Mua quy·ªÅn truy c·∫≠p Symbol Trading Scalping"
}
```

**Response:**
```json
{
  "order_id": "123e4567-e89b-12d3-a456-426614174000",
  "total_amount": 500000,
  "status": "pending_payment", 
  "payment_method": "wallet",
  "items": [...],
  "created_at": "2025-09-22T10:00:00Z",
  "message": "Order created successfully. Total: 500000 VND"
}
```

### B∆∞·ªõc 2A: Thanh to√°n b·∫±ng V√≠

**API:** `POST /api/seapay/symbol/order/{order_id}/pay-wallet`

**Lu·ªìng x·ª≠ l√Ω:**
1. Ki·ªÉm tra order status = `pending_payment`
2. L·∫•y wallet c·ªßa user v√† ki·ªÉm tra balance
3. Validate: `wallet.balance >= order.total_amount`
4. T·∫°o ledger entry:
   ```
   tx_type: "purchase"
   is_credit: false  
   amount: order.total_amount
   balance_before: wallet.balance
   balance_after: wallet.balance - order.total_amount
   order_id: order.order_id
   ```
5. C·∫≠p nh·∫≠t wallet balance
6. C·∫≠p nh·∫≠t order status ‚Üí `paid`
7. T·∫°o licenses cho t·ª´ng item trong order

**Response:**
```json
{
  "success": true,
  "message": "Payment processed successfully",
  "order_id": "123e4567-e89b-12d3-a456-426614174000",
  "amount_charged": 500000,
  "wallet_balance_after": 1500000,
  "licenses_created": 1
}
```

### B∆∞·ªõc 2B: Thanh to√°n b·∫±ng SePay

**API:** `POST /api/seapay/symbol/order/{order_id}/pay-sepay`

**Lu·ªìng x·ª≠ l√Ω:**
1. T·∫°o PaymentIntent v·ªõi `purpose = "order_payment"`
2. Li√™n k·∫øt intent v·ªõi order: `order.payment_intent = intent`
3. Sinh QR code v·ªõi order_code t·ª´ intent

**Response:**
```json
{
  "intent_id": "456e7890-e89b-12d3-a456-426614174001",
  "order_code": "TOPUP1727001234ABCD", 
  "amount": 500000,
  "currency": "VND",
  "expires_at": "2025-09-22T11:00:00Z",
  "qr_code_url": "https://qr.sepay.vn/img?acc=96247CISI1&bank=BIDV&amount=500000&des=TOPUP1727001234ABCD&template=compact",
  "message": "Payment intent created. Please scan QR code to complete payment."
}
```

**Webhook Processing:**
Khi user thanh to√°n th√†nh c√¥ng, SePay g·ª≠i webhook ‚Üí PaymentService x·ª≠ l√Ω ‚Üí Trigger `BotPurchaseService.process_sepay_payment_completion()` ‚Üí C·∫•p license.

### B∆∞·ªõc 3: C·∫•p License

Sau khi thanh to√°n th√†nh c√¥ng (c·∫£ 2 ph∆∞∆°ng th·ª©c), h·ªá th·ªëng t·ª± ƒë·ªông c·∫•p license:

**Logic:**
```python
for item in order.items:
    start_at = now()
    end_at = start_at + timedelta(days=item.license_days) if item.license_days else None
    
    # Ki·ªÉm tra license existing
    existing_license = PayUserSymbolLicense.objects.filter(
        user=order.user, 
        symbol_id=item.symbol_id,
        status='active'
    ).first()
    
    if existing_license:
        # Extend license existing
        if existing_license.end_at and end_at:
            existing_license.end_at = max(existing_license.end_at, end_at)
        elif not end_at:  # New license is lifetime
            existing_license.end_at = None  # Upgrade to lifetime
        existing_license.save()
    else:
        # T·∫°o license m·ªõi
        PayUserSymbolLicense.objects.create(
            user=order.user,
            symbol_id=item.symbol_id,
            order=order,
            status='active',
            start_at=start_at,
            end_at=end_at
        )
```

## üîç API Endpoints

### Qu·∫£n l√Ω ƒë∆°n h√†ng

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/seapay/symbol/order/create` | ‚úÖ | T·∫°o ƒë∆°n h√†ng mua quy·ªÅn truy c·∫≠p symbol |
| POST | `/api/seapay/symbol/order/{order_id}/pay-wallet` | ‚úÖ | Thanh to√°n b·∫±ng v√≠ |
| POST | `/api/seapay/symbol/order/{order_id}/pay-sepay` | ‚úÖ | T·∫°o payment intent SePay |
| GET | `/api/seapay/symbol/orders/history` | ‚úÖ | L·ªãch s·ª≠ mua h√†ng |

### Qu·∫£n l√Ω quy·ªÅn truy c·∫≠p

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/seapay/symbol/{symbol_id}/access` | ‚úÖ | Ki·ªÉm tra quy·ªÅn truy c·∫≠p symbol |
| GET | `/api/seapay/symbol/licenses` | ‚úÖ | Danh s√°ch license c·ªßa user |

---

# üìÆ Postman Testing Guide

## Chu·∫©n b·ªã Environment

### 1. T·∫°o Environment Variables
```json
{
  "base_url": "http://localhost:8000",
  "access_token": "",
  "user_id": "",
  "order_id": "",
  "symbol_id": "123"
}
```

### 2. Authentication Headers
T·∫•t c·∫£ requests c·∫ßn header:
```
Authorization: Bearer {{access_token}}
Content-Type: application/json
```

## üß™ Test Scenarios

### Scenario 1: Mua bot b·∫±ng Wallet

#### Step 1: Login ƒë·ªÉ l·∫•y access token
```http
POST {{base_url}}/api/auth/login
Content-Type: application/json

{
  "email": "user@example.com", 
  "password": "password123"
}
```

**Postman Test Script:**
```javascript
if (pm.response.code === 200) {
    const response = pm.response.json();
    pm.environment.set("access_token", response.access_token);
    pm.environment.set("user_id", response.user.id);
    console.log("‚úÖ Login successful");
}
```

#### Step 2: Ki·ªÉm tra wallet balance
```http
GET {{base_url}}/api/seapay/wallet
Authorization: Bearer {{access_token}}
```

**Expected Response:**
```json
{
  "wallet_id": "123e4567-e89b-12d3-a456-426614174000",
  "balance": 2000000.00,
  "currency": "VND", 
  "status": "active"
}
```

#### Step 3: T·∫°o ƒë∆°n h√†ng mua symbol
```http
POST {{base_url}}/api/seapay/symbol/order/create
Authorization: Bearer {{access_token}}
Content-Type: application/json

{
  "items": [
    {
      "symbol_id": {{symbol_id}},
      "price": 500000,
      "license_days": 30,
      "metadata": {
        "version": "v2.0",
        "package": "premium"
      }
    }
  ],
  "payment_method": "wallet",
  "description": "Mua Bot Trading Scalping - Test"
}
```

**Postman Test Script:**
```javascript
if (pm.response.code === 200) {
    const response = pm.response.json();
    pm.environment.set("order_id", response.order_id);
    console.log("‚úÖ Order created:", response.order_id);
    console.log("üí∞ Total amount:", response.total_amount);
    
    // Validate response structure
    pm.test("Order created successfully", function() {
        pm.expect(response.status).to.eql("pending_payment");
        pm.expect(response.payment_method).to.eql("wallet");
        pm.expect(response.total_amount).to.eql(500000);
    });
}
```

#### Step 4: Thanh to√°n b·∫±ng wallet
```http
POST {{base_url}}/api/seapay/symbol/order/{{order_id}}/pay-wallet
Authorization: Bearer {{access_token}}
```

**Expected Response:**
```json
{
  "success": true,
  "message": "Payment processed successfully",
  "order_id": "123e4567-e89b-12d3-a456-426614174000",
  "amount_charged": 500000,
  "wallet_balance_after": 1500000,
  "licenses_created": 1
}
```

**Postman Test Script:**
```javascript
if (pm.response.code === 200) {
    const response = pm.response.json();
    console.log("‚úÖ Payment successful");
    console.log("üí≥ Amount charged:", response.amount_charged);
    console.log("üí∞ Balance after:", response.wallet_balance_after);
    console.log("üé´ Licenses created:", response.licenses_created);
    
    pm.test("Payment processed successfully", function() {
        pm.expect(response.success).to.be.true;
        pm.expect(response.licenses_created).to.be.above(0);
    });
}
```

#### Step 5: Ki·ªÉm tra quy·ªÅn truy c·∫≠p bot
```http
GET {{base_url}}/api/seapay/bot/{{symbol_id}}/access
Authorization: Bearer {{access_token}}
```

**Expected Response:**
```json
{
  "has_access": true,
  "license_id": "789e0123-e89b-12d3-a456-426614174002",
  "start_at": "2025-09-22T10:00:00Z",
  "end_at": "2025-10-22T10:00:00Z",
  "is_lifetime": false,
  "expires_soon": false
}
```

#### Step 6: Xem l·ªãch s·ª≠ mua h√†ng
```http
GET {{base_url}}/api/seapay/symbol/orders/history?page=1&limit=10
Authorization: Bearer {{access_token}}
```

### Scenario 2: Mua symbol b·∫±ng SePay Transfer

#### Step 1-2: Gi·ªëng nh∆∞ Scenario 1

#### Step 3: T·∫°o ƒë∆°n h√†ng v·ªõi SePay
```http
POST {{base_url}}/api/seapay/symbol/order/create
Authorization: Bearer {{access_token}}
Content-Type: application/json

{
  "items": [
    {
      "symbol_id": {{symbol_id}},
      "price": 1000000,
      "license_days": null,
      "metadata": {
        "version": "v3.0",
        "package": "lifetime"
      }
    }
  ],
  "payment_method": "sepay_transfer",
  "description": "Mua Bot Premium - Lifetime License"
}
```

#### Step 4: T·∫°o SePay payment intent
```http
POST {{base_url}}/api/seapay/symbol/order/{{order_id}}/pay-sepay
Authorization: Bearer {{access_token}}
```

**Expected Response:**
```json
{
  "intent_id": "456e7890-e89b-12d3-a456-426614174001",
  "order_code": "TOPUP1727001234ABCD",
  "amount": 1000000,
  "currency": "VND",
  "expires_at": "2025-09-22T11:00:00Z",
  "qr_code_url": "https://qr.sepay.vn/img?acc=96247CISI1&bank=BIDV&amount=1000000&des=TOPUP1727001234ABCD&template=compact",
  "message": "Payment intent created. Please scan QR code to complete payment."
}
```

**Postman Test Script:**
```javascript
if (pm.response.code === 200) {
    const response = pm.response.json();
    pm.environment.set("intent_id", response.intent_id);
    pm.environment.set("order_code", response.order_code);
    
    console.log("‚úÖ Payment intent created");
    console.log("üè¶ Order code:", response.order_code);
    console.log("üì± QR URL:", response.qr_code_url);
    
    // Copy QR URL ƒë·ªÉ test
    pm.globals.set("qr_url", response.qr_code_url);
}
```

#### Step 5: M√¥ ph·ªèng SePay webhook (Test only)
```http
POST {{base_url}}/api/seapay/callback
Content-Type: application/json

{
  "id": 24088296,
  "gateway": "BIDV",
  "transactionDate": "2025-09-22T10:30:00Z",
  "accountNumber": "1160976779",
  "subAccount": "96247CISI1",
  "code": null,
  "content": "{{order_code}}",
  "transferType": "in",
  "description": "BankAPINotify {{order_code}}",
  "transferAmount": 1000000,
  "referenceCode": "{{$randomUUID}}",
  "accumulated": 0
}
```

#### Step 6: Ki·ªÉm tra order status v√† license
```http
GET {{base_url}}/api/seapay/symbol/{{symbol_id}}/access
Authorization: Bearer {{access_token}}
```

## üî¨ Advanced Test Cases

### Test Case 1: Insufficient Wallet Balance ‚ö†Ô∏è
**M·ª•c ƒë√≠ch:** Ki·ªÉm tra validation s·ªë d∆∞ v√≠ khi t·∫°o ƒë∆°n h√†ng

```http
POST {{base_url}}/api/seapay/symbol/order/create
Authorization: Bearer {{access_token}}
Content-Type: application/json

{
  "items": [
    {
      "symbol_id": 123, 
      "price": 999999999,
      "license_days": 30
    }
  ],
  "payment_method": "wallet",
  "description": "Test insufficient balance"
}
```

**Expected Response:** `400 Bad Request`
```json
{
  "error": "Insufficient wallet balance. Required: 999999999 VND, Available: 10000.00 VND"
}
```

**Postman Test Script:**
```javascript
pm.test("Should reject insufficient balance", function() {
    pm.expect(pm.response.code).to.be.oneOf([400, 422]);
    const response = pm.response.json();
    pm.expect(response.error).to.include("Insufficient wallet balance");
});
```

### Test Case 2: Valid Purchase within Balance ‚úÖ
**M·ª•c ƒë√≠ch:** Ki·ªÉm tra mua h√†ng th√†nh c√¥ng trong ph·∫°m vi s·ªë d∆∞

```http
POST {{base_url}}/api/seapay/symbol/order/create
Authorization: Bearer {{access_token}}
Content-Type: application/json

{
  "items": [
    {
      "symbol_id": 456, 
      "price": 5000,
      "license_days": 7
    }
  ],
  "payment_method": "wallet",
  "description": "Test valid purchase"
}
```

**Expected Response:** `200 OK`
```json
{
  "order_id": "uuid",
  "total_amount": "5000",
  "status": "pending_payment",
  "message": "Order created successfully"
}
```

**Then proceed with wallet payment:**
```http
POST {{base_url}}/api/seapay/symbol/order/{{order_id}}/pay-wallet
```

**Expected:** Wallet balance reduced, license created.
  "payment_method": "wallet"
}
```
‚Üí Sau ƒë√≥ try thanh to√°n ‚Üí Expect error

### Test Case 2: Multi-item Order
```http
{
  "items": [
    {"symbol_id": 123, "price": 500000, "license_days": 30},
    {"symbol_id": 124, "price": 300000, "license_days": 60},
    {"symbol_id": 125, "price": 1000000, "license_days": null}
  ],
  "payment_method": "wallet"
}
```

### Test Case 3: License Extension
Mua c√πng 1 bot 2 l·∫ßn ‚Üí Verify license end_at ƒë∆∞·ª£c extend.

### Test Case 4: Expired Order
T·∫°o order ‚Üí ƒê·ª£i h·∫øt h·∫°n ‚Üí Try thanh to√°n ‚Üí Expect error.

## üìä Postman Collection Structure

```
üìÅ Bot Purchase System
‚îú‚îÄ‚îÄ üìÅ 01. Authentication
‚îÇ   ‚îú‚îÄ‚îÄ Login
‚îÇ   ‚îî‚îÄ‚îÄ Get Current User
‚îú‚îÄ‚îÄ üìÅ 02. Wallet Management  
‚îÇ   ‚îú‚îÄ‚îÄ Get Wallet Info
‚îÇ   ‚îî‚îÄ‚îÄ Get Wallet History
‚îú‚îÄ‚îÄ üìÅ 03. Order Management
‚îÇ   ‚îú‚îÄ‚îÄ Create Order (Wallet)
‚îÇ   ‚îú‚îÄ‚îÄ Create Order (SePay)
‚îÇ   ‚îú‚îÄ‚îÄ Pay with Wallet
‚îÇ   ‚îú‚îÄ‚îÄ Pay with SePay
‚îÇ   ‚îî‚îÄ‚îÄ Get Order History
‚îú‚îÄ‚îÄ üìÅ 04. License Management
‚îÇ   ‚îú‚îÄ‚îÄ Check Bot Access
‚îÇ   ‚îú‚îÄ‚îÄ Get User Licenses
‚îÇ   ‚îî‚îÄ‚îÄ Get License Details
‚îú‚îÄ‚îÄ üìÅ 05. Webhook Testing
‚îÇ   ‚îú‚îÄ‚îÄ SePay Callback Success
‚îÇ   ‚îî‚îÄ‚îÄ SePay Callback Invalid
‚îî‚îÄ‚îÄ üìÅ 06. Error Scenarios
    ‚îú‚îÄ‚îÄ Insufficient Balance
    ‚îú‚îÄ‚îÄ Invalid Symbol ID
    ‚îú‚îÄ‚îÄ Order Not Found
    ‚îî‚îÄ‚îÄ Expired Order
```

## üéØ Test Validation Checklist

### ‚úÖ Wallet Payment Flow
- [ ] Order t·∫°o th√†nh c√¥ng v·ªõi status `pending_payment`
- [ ] Wallet balance ƒë·ªß ‚Üí Payment th√†nh c√¥ng
- [ ] Wallet balance kh√¥ng ƒë·ªß ‚Üí Error message r√µ r√†ng
- [ ] Ledger entry ƒë∆∞·ª£c t·∫°o v·ªõi ƒë√∫ng tx_type v√† amount
- [ ] Order status chuy·ªÉn th√†nh `paid`
- [ ] License ƒë∆∞·ª£c t·∫°o v·ªõi ƒë√∫ng th·ªùi h·∫°n
- [ ] Wallet balance c·∫≠p nh·∫≠t ch√≠nh x√°c

### ‚úÖ SePay Payment Flow  
- [ ] Payment intent t·∫°o th√†nh c√¥ng
- [ ] QR code URL valid v√† accessible
- [ ] Webhook processing th√†nh c√¥ng
- [ ] License ƒë∆∞·ª£c c·∫•p sau webhook
- [ ] Order status c·∫≠p nh·∫≠t ƒë√∫ng

### ‚úÖ License Management
- [ ] User c√≥ quy·ªÅn truy c·∫≠p bot sau mua
- [ ] License lifetime vs c√≥ th·ªùi h·∫°n
- [ ] License extension khi mua th√™m
- [ ] Multiple licenses cho multiple bots
- [ ] Expired license kh√¥ng cho ph√©p truy c·∫≠p

### ‚úÖ Error Handling
- [ ] Invalid symbol_id ‚Üí 404 Error
- [ ] Order not found ‚Üí 404 Error  
- [ ] Insufficient balance ‚Üí 400 Error
- [ ] Expired order ‚Üí 400 Error
- [ ] Unauthenticated request ‚Üí 401 Error

## üöÄ Performance Testing

### Load Testing v·ªõi Postman
1. **Concurrent Orders**: 10 users t·∫°o order c√πng l√∫c
2. **Payment Processing**: Test ƒë·ªìng th·ªùi wallet payment
3. **License Queries**: Bulk check bot access
4. **Webhook Load**: Multiple webhook callbacks

### Monitoring Points
- Response time < 2s cho order creation
- Payment processing < 5s
- License check < 500ms
- Database connection pooling
- Memory usage trong bulk operations

---

**üéâ Ready to test!** Import Postman collection v√† b·∫Øt ƒë·∫ßu test to√†n b·ªô lu·ªìng mua bot.